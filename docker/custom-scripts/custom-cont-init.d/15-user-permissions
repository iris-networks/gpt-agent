#!/usr/bin/with-contenv bash

# Configure user relationships and permissions
echo "Setting up user permissions and relationships..."

# Remove abc from sudo group and set restricted permissions
gpasswd -d abc sudo 2>/dev/null || true
echo "abc ALL=(abc) NOPASSWD:ALL" > /etc/sudoers.d/abc-restrict
echo "abc ALL=(root) !ALL" >> /etc/sudoers.d/abc-restrict
echo "abc ALL=(!abc) !ALL" >> /etc/sudoers.d/abc-restrict
chmod 0440 /etc/sudoers.d/abc-restrict

# Set up group relationships
usermod -a -G abc nodeuser 2>/dev/null || true
usermod -a -G nodeuser abc 2>/dev/null || true

# Ensure proper ownership and permissions
chown -R abc:abc /config

# Set permissions and sticky bit to ensure future files are accessible
chmod -R g+rwxs /config

# Set default ACL to ensure any new files/folders inherit proper permissions
setfacl -R -d -m g:nodeuser:rwx /config 2>/dev/null || true
setfacl -R -d -m g:abc:rwx /config 2>/dev/null || true

# Create config directories
mkdir -p /config/.config /config/.local


